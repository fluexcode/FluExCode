# .github/workflows/ci-cd.yml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Manuel Ã§alÄ±ÅŸtÄ±rma iÃ§in

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      # MySQL servisi (test iÃ§in)
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: cipherx_test
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_pass
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306
    
    steps:
    - name: ğŸ—‚ï¸ Kodu al
      uses: actions/checkout@v4
    
    - name: ğŸ Python kur
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ BaÄŸÄ±mlÄ±lÄ±klarÄ± kur
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: ğŸ”§ Ã‡evre deÄŸiÅŸkenlerini ayarla
      run: |
        echo "DATABASE_URL=mysql+pymysql://test_user:test_pass@localhost:3306/cipherx_test" >> .env
        echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
        echo "DEBUG=False" >> .env
    
    - name: ğŸ§ª Testleri Ã§alÄ±ÅŸtÄ±r
      run: |
        pytest --cov=app --cov-report=xml --cov-report=html
    
    - name: ğŸ“Š Test kapsamÄ±nÄ± yÃ¼kle
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: true
    
    - name: ğŸ—ï¸ Database migration
      run: |
        alembic upgrade head
    
    - name: ğŸš¨ Linting (flake8)
      run: |
        pip install flake8
        flake8 app --max-line-length=120 --count --statistics

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: test  # Testler baÅŸarÄ±lÄ± olursa Ã§alÄ±ÅŸ
    if: github.ref == 'refs/heads/main'  # Sadece main branch'de deploy
    
    steps:
    - name: ğŸ—‚ï¸ Kodu al
      uses: actions/checkout@v4
    
    - name: ğŸ Python kur
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ” Secrets'larÄ± ayarla
      env:
        TWITCH_CLIENT_ID: ${{ secrets.TWITCH_CLIENT_ID }}
        TWITCH_CLIENT_SECRET: ${{ secrets.TWITCH_CLIENT_SECRET }}
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      run: |
        echo "TWITCH_CLIENT_ID=$TWITCH_CLIENT_ID" >> .env
        echo "TWITCH_CLIENT_SECRET=$TWITCH_CLIENT_SECRET" >> .env
        echo "SECRET_KEY=$SECRET_KEY" >> .env
        echo "DATABASE_URL=$DATABASE_URL" >> .env
    
    - name: ğŸ³ Docker Build
      run: |
        docker build -t cipherx-bot:latest .
    
    - name: ğŸ“¦ Docker Hub'a push (isteÄŸe baÄŸlÄ±)
      if: success()
      run: |
        docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
        docker tag cipherx-bot:latest ${{ secrets.DOCKER_USERNAME }}/cipherx-bot:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/cipherx-bot:latest
    
    - name: ğŸš€ VPS/Server'a deploy (SSH ile)
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          cd /var/www/cipherx-bot
          git pull origin main
          docker-compose down
          docker-compose pull
          docker-compose up -d --build
          docker system prune -f
