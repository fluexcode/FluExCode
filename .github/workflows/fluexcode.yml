name: ğŸš€ Deploy FluexCode Bot

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      restart_bot:
        description: 'Botu yeniden baÅŸlat'
        required: false
        default: false

env:
  BOT_NAME: "FluexCode Bot"
  
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ› ï¸ FluexCode Setup
      run: echo "ğŸš€ ${{ env.BOT_NAME }} baÅŸlatÄ±lÄ±yor..."
      
    - name: ğŸ“¥ Repository'yi Ã§ek
      uses: actions/checkout@v3
      
    - name: âš™ï¸ Node.js kur
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: ğŸ“¦ FluexCode baÄŸÄ±mlÄ±lÄ±klarÄ±
      run: npm install
      
    - name: ğŸ”§ FluexCode Environment
      run: |
        echo "FLUEXCODE_BOT_USERNAME=${{ secrets.FLUEXCODE_USERNAME }}" >> .fluexcode-env
        echo "FLUEXCODE_OAUTH_TOKEN=${{ secrets.FLUEXCODE_OAUTH }}" >> .fluexcode-env
        echo "FLUEXCODE_CHANNEL=${{ secrets.FLUEXCODE_CHANNEL }}" >> .fluexcode-env
        echo "FLUEXCODE_PANEL_PORT=3000" >> .fluexcode-env
        echo "FLUEXCODE_PANEL_PASSWORD=${{ secrets.FLUEXCODE_PANEL_PASS }}" >> .fluexcode-env
        echo "FLUEXCODE_PREFIX=!" >> .fluexcode-env
        
    - name: ğŸ§ª FluexCode Test
      run: |
        echo "âœ… Environment kontrolÃ¼:"
        if [ -f ".fluexcode-env" ]; then
          echo "âœ… .fluexcode-env dosyasÄ± oluÅŸturuldu"
        else
          echo "âŒ .fluexcode-env dosyasÄ± oluÅŸturulamadÄ±"
          exit 1
        fi
        
    - name: ğŸš€ FluexCode Bot'u baÅŸlat
      run: |
        # Background'da baÅŸlat
        npm start &
        BOT_PID=$!
        
        echo "â³ FluexCode Bot baÅŸlatÄ±lÄ±yor (PID: $BOT_PID)..."
        
        # 20 saniye bekle
        sleep 20
        
        # Bot'un Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± kontrol et
        if ps -p $BOT_PID > /dev/null; then
          echo "âœ… ${{ env.BOT_NAME }} baÅŸarÄ±yla Ã§alÄ±ÅŸÄ±yor!"
        else
          echo "âŒ ${{ env.BOT_NAME }} baÅŸlatÄ±lamadÄ±"
          exit 1
        fi
        
    - name: ğŸ”„ SÃ¼rekli Ã§alÄ±ÅŸtÄ±r
      run: |
        echo "ğŸ”„ ${{ env.BOT_NAME }} Ã§alÄ±ÅŸÄ±yor..."
        # GitHub Actions timeout'u iÃ§in keep-alive
        while true; do
          sleep 60
          echo "$(date): ğŸ¤– FluexCode Bot aktif"
        done